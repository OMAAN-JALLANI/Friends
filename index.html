<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sorry â€” My Moonlight</title>
<style>
  :root{
    --bg-a:#fff6f9; --bg-b:#fff1e8;
    --accent-1:#ff7eb3; --accent-2:#ffb6d5;
    --muted:#4b4250;
    --card: rgba(255,255,255,0.96);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  body{
    background: linear-gradient(120deg,var(--bg-a),var(--bg-b));
    display:flex; align-items:center; justify-content:center;
    padding:18px; overflow:hidden;
  }

  .stage {
    width:100%; max-width:980px; min-height:560px; border-radius:18px;
    position:relative; overflow:hidden;
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,250,250,0.95));
    box-shadow: 0 30px 80px rgba(120,20,60,0.08);
    display:flex; flex-direction:column; align-items:center; gap:14px; padding:22px;
  }

  /* raindrops canvas sits behind content */
  #rainCanvas { position:absolute; inset:0; z-index:1; pointer-events:none; }

  .content { position:relative; z-index:10; width:100%; display:flex; flex-direction:column; align-items:center; gap:12px; }

  h1 { margin:0; font-size:30px; background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); -webkit-background-clip:text; color:transparent; font-weight:800; letter-spacing:.6px; text-align:center; }

  /* typewriter card */
  .sms-card { width:100%; max-width:720px; background:var(--card); padding:18px; border-radius:14px; color:var(--muted); box-shadow:0 10px 30px rgba(0,0,0,0.06); text-align:left; }
  .sms-card p{margin:6px 0; font-size:15px; line-height:1.45}

  .controls { display:flex; gap:12px; align-items:center; margin-top:6px; }

  .btn { padding:12px 20px; border-radius:999px; border:0; cursor:pointer; font-weight:700; color:#fff;
        background: linear-gradient(90deg,var(--accent-1),var(--accent-2)); box-shadow:0 14px 36px rgba(255,90,150,0.12); }

  .btn.ghost { background:transparent; border:1px solid rgba(0,0,0,0.06); color:var(--muted); box-shadow:none; }

  /* balloon/rose stage */
  #balloonStage { width:100%; min-height:320px; position:relative; display:flex; align-items:center; justify-content:center; z-index:8; }

  .rose {
    width:84px; height:100px; border-radius:50% 50% 46% 46%;
    display:flex; align-items:center; justify-content:center; position:absolute; cursor:pointer;
    transition: transform .18s ease, opacity .2s ease; box-shadow:0 8px 26px rgba(0,0,0,0.12);
    user-select:none;
  }
  .rose .pin { position:absolute; top:-16px; left:50%; transform:translateX(-50%); font-size:18px; cursor:pointer; }
  .rose .string { position:absolute; bottom:-22px; left:50%; transform:translateX(-50%); width:2px; height:22px; background: rgba(0,0,0,0.12); }

  .rose-pop { animation: popR .45s ease forwards; }
  @keyframes popR { 0%{transform:scale(1);opacity:1}60%{transform:scale(1.4) rotate(6deg)}100%{transform:scale(0);opacity:0} }

  .message-box { width:100%; max-width:720px; background:#fff; padding:12px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.06); min-height:56px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:16px; z-index:9; }

  /* video overlay */
  #videoOverlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:60; visibility:hidden; opacity:0; transition:opacity .25s ease, visibility .25s; }
  #videoOverlay.active { visibility:visible; opacity:1; }
  #videoOverlay video { max-width:92%; border-radius:12px; box-shadow:0 30px 80px rgba(0,0,0,0.6); }

  /* cartoon + dialog */
  .cartoon { width:220px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.12); }
  .dialog { margin-top:12px; background:linear-gradient(180deg,#fff,#fff4f8); padding:14px; border-radius:12px; max-width:720px; text-align:center; color:var(--muted); box-shadow:0 10px 30px rgba(0,0,0,0.06); }

  /* final screen */
  .final-card { text-align:center; }

  /* emoji rain layer */
  #emojiLayer { position:absolute; inset:0; z-index:6; pointer-events:none; overflow:hidden; }

  @media(max-width:760px){
    .stage{ padding:14px }
    h1{ font-size:20px }
    .cartoon{ width:160px }
    .rose{ width:62px; height:78px }
  }
</style>
</head>
<body>
  <div class="stage" id="stageRoot">
    <canvas id="rainCanvas"></canvas>
    <div id="emojiLayer" aria-hidden="true"></div>

    <!-- Step 1: intro -->
    <div class="content" id="step1">
      <h1>My Moonlight â€” I'm Sorry</h1>
      <div class="sms-card">
        <p id="introLine1"><strong>Baby Girl ğŸ¥º â€”</strong> SOrry na yrr</p>
        <p id="introLine2">sb sy zada IMPORTANCE, PRIOTYp k lyia hn na.. ğŸ—ğŸ™‚</p>
        <p id="introLine3">maff kr do na... cutiee pieee please â˜¹ğŸ’</p>
        <p id="introLine4">Nhi milta na sukoon, apna dil to hurt kr ka â˜¹ğŸ¥€</p>
        <p id="introLine5">Press below and let me try to show you how sorry I am.</p>
      </div>

      <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
        <button class="btn" id="startBtn">Continue Apologize ?</button>
        <button class="btn ghost" id="muteBtn">ğŸ”ˆ</button>
      </div>
    </div>

    <!-- Step 2: roses -->
    <div class="content" id="step2" style="display:none;">
      <h1>mara sir smajh kr.. phor do in balloons koğŸ™‚</h1>
      <div id="balloonStage" aria-live="polite"></div>
      <div class="message-box" id="balloonMsg">mara sir smajh kr.. phor do in balloons koğŸ™‚</div>
      <div style="margin-top:10px;"><button class="btn ghost" id="skipToVideoBtn">Skip to video</button></div>
    </div>

    <!-- Video overlay -->
    <div id="videoOverlay" aria-hidden="true">
      <div style="width:100%; max-width:980px;">
        <video id="sorryVideo" src="./Components/sorry_video.webm" controls playsinline></video>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
          <button class="btn" id="continueAfterVideo">Continue</button>
          <button class="btn ghost" id="closeVideo">Close Video</button>
        </div>
      </div>
    </div>

    <!-- Step 3: cartoon dialog -->
    <div class="content" id="step4" style="display:none;">
      <img id="cartoonImg" class="cartoon" src="./Components/image3.webp" alt="cartoon">
      <div class="dialog" id="dialogBox">Click below to read my message ğŸ’¬</div>
      <div style="margin-top:12px;"><button class="btn" id="dialogNextBtn">Show Next</button></div>
    </div>

    <!-- Step 4: final -->
    <div class="content" id="step5" style="display:none;">
      <h1>ğŸ’ Iâ€™m Sachi Maffi ğŸ™‚</h1>
      <div class="sms-card final-card">
        <p id="finalLine">Galti to insano sy hoti hn na.... is lyia mj ys galti hwe... ap sy nhi ho skti Q k ap to angelâœ¨ğŸ™‚ na, PLEASE PYALA WLA BABYâœ¨ğŸ€ğŸ™‚
          <br> Galti sy Galti kr de mein na.. Monkey jo hu... ğŸ˜Ab nhi kro ga na asy.. First or last time tha.. na.. kasam sy na... ap ko to pta hn na mara..My Queen ğŸ’–ğŸ€ğŸ™‚</p>
      </div>
      <div style="margin-top:12px;"><button class="btn" id="restartBtn">Again Experience</button></div>
    </div>

    <!-- audio elements -->
    <audio id="bgMusic" src="./Components/song.mp3" preload="auto"></audio>
    <audio id="popSound" src="pop.mp3" preload="auto"></audio>

  </div>

<script>
/* ---------------- CONFIG / TEXTS ---------------- */
const roseMessages = [
  "I know... mein hurt krta ho ap ko ğŸŒ¸",
  "Maaf kar do na, main dance or song or loori be sunio ga ğŸ™‚",
  "Mein bs acting kr r tha na... lakin wo glat ho gyia ğŸ¥º ğŸ’—",
  "Ya phool murjha jya ga... yr ap k bina ğŸ™‚ğŸ€",
  "Give me one chance to prove I'll change ğŸ’–",
  "Ap jitna marzi rok lo... mein phr be manio ga ap ko ğŸ™‚",
];

const finalDialogues = [
  "Mari pyari se Moon Lightâœ¨ğŸ˜Š",
  "ho gyee na galtii...Sweet HeartğŸ¥º",
  " Promise na ab nhi kro ga naa janaaa ğŸ’",
  "Please let me make it up to you ğŸ’, My Queen"
];

/* -------------- elements -------------- */
const step1 = document.getElementById('step1');
const startBtn = document.getElementById('startBtn');
const muteBtn = document.getElementById('muteBtn');
const step2 = document.getElementById('step2');
const balloonStage = document.getElementById('balloonStage');
const balloonMsg = document.getElementById('balloonMsg');
const skipToVideoBtn = document.getElementById('skipToVideoBtn');
const videoOverlay = document.getElementById('videoOverlay');
const sorryVideo = document.getElementById('sorryVideo');
const closeVideo = document.getElementById('closeVideo');
const continueAfterVideo = document.getElementById('continueAfterVideo');
const step4 = document.getElementById('step4');
const dialogBox = document.getElementById('dialogBox');
const dialogNextBtn = document.getElementById('dialogNextBtn');
const step5 = document.getElementById('step5');
const restartBtn = document.getElementById('restartBtn');

const emojiLayer = document.getElementById('emojiLayer');
const bgMusic = document.getElementById('bgMusic');
const popSound = document.getElementById('popSound');

/* -------------- music timing -------------- */
const startTime = 128; // 2:08
const endTime = 355;   // 5:55
let musicInterval;
let musicPlaying = false;
let userInteracted = false;

/* -------------- raindrops canvas -------------- */
const canvas = document.getElementById('rainCanvas');
const ctx = canvas.getContext('2d');
function resizeCanvas(){
  canvas.width = canvas.clientWidth || canvas.offsetWidth;
  canvas.height = canvas.clientHeight || canvas.offsetHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

let drops = [];
function makeDrops(){
  drops = [];
  const density = Math.round((canvas.width * canvas.height) / 70000);
  for(let i=0;i<Math.max(12,density);i++){
    drops.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      l: 8 + Math.random()*18,
      xs: -0.5 + Math.random()*1,
      ys: 1 + Math.random()*3,
      a: 0.2 + Math.random()*0.7
    });
  }
}
makeDrops();

function drawDrops(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const d of drops){
    ctx.beginPath();
    ctx.strokeStyle = `rgba(255,255,255,${d.a})`;
    ctx.lineWidth = 1.4;
    ctx.moveTo(d.x, d.y);
    ctx.lineTo(d.x + d.xs * d.l, d.y + d.ys * d.l);
    ctx.stroke();

    d.x += d.xs;
    d.y += d.ys;
    if(d.y > canvas.height + 20){ d.y = -20; d.x = Math.random()*canvas.width; }
    if(d.x > canvas.width + 20) d.x = -10;
    if(d.x < -20) d.x = canvas.width + 10;
  }
  requestAnimationFrame(drawDrops);
}
drawDrops();

/* -------------- emoji rain (soft) -------------- */
const rainEmojis = ["ğŸ’–","ğŸŒ¸","âœ¨","ğŸ’","ğŸ‹","ğŸ¼"];
function createEmoji(){
  const el = document.createElement('div');
  el.style.position='absolute';
  el.style.left = (Math.random()*92 + 2) + 'vw';
  el.style.top = '-8vh';
  el.style.fontSize = (12 + Math.random()*26) + 'px';
  el.style.opacity = 0.8;
  el.style.pointerEvents='none';
  el.textContent = rainEmojis[Math.floor(Math.random()*rainEmojis.length)];
  emojiLayer.appendChild(el);
  const dur = 6000 + Math.random()*7000;
  el.animate([{ transform:'translateY(0)' , opacity:1 }, { transform:`translateY(${window.innerHeight + 100}px)`, opacity:0.25 }], { duration:dur, easing:'linear' });
  setTimeout(()=> { try{ el.remove() }catch(e){} }, dur+80);
}
setInterval(createEmoji, 520);

/* -------------- start music segment helper -------------- */
async function startMusicSegment() {
  if(userInteracted) return;
  userInteracted = true;
  try { bgMusic.currentTime = startTime; bgMusic.volume = 0.45; await bgMusic.play(); musicPlaying = true; } catch(e) { /* blocked */ }
  musicInterval = setInterval(() => {
    if(bgMusic.currentTime >= endTime){
      bgMusic.pause();
      musicPlaying = false;
      clearInterval(musicInterval);
    }
  }, 300);
}

/* mute toggle */
muteBtn.addEventListener('click', ()=>{
  if(bgMusic.muted){ bgMusic.muted=false; muteBtn.textContent='ğŸ”ˆ'; } else { bgMusic.muted=true; muteBtn.textContent='ğŸ”‡'; }
});

/* -------------- Stage transitions -------------- */
startBtn.addEventListener('click', async () => {
  await startMusicSegment();
  // transition to roses
  step1.style.display='none';
  step2.style.display='flex';
  initRoses();
});

/* -------------- Roses (balloons) -------------- */
let poppedCount = 0;
function initRoses(){
  balloonStage.innerHTML = '';
  poppedCount = 0;
  const N = Math.min(roseMessages.length, 7);
  const colors = ['#ffb6d5','#ffd1a8','#bfeccb','#c7d2ff','#ffd1f6','#fff1a8','#fcd5ff'];
  for(let i=0;i<N;i++){
    const r = document.createElement('div');
    r.className='rose';
    r.style.background = `radial-gradient(circle at 40% 30%, #fff8f9, ${colors[i%colors.length]})`;
    const left = 6 + Math.random()*88;
    const top = 8 + Math.random()*66;
    r.style.left = left + '%';
    r.style.top = top + '%';
    r.dataset.idx = i;

    const pin = document.createElement('div');
    pin.className='pin'; pin.textContent='ğŸ“Œ';
    pin.addEventListener('click',(ev)=>{ ev.stopPropagation(); popRose(r); });

    const s = document.createElement('div'); s.className='string';
    r.appendChild(pin); r.appendChild(s);

    r.addEventListener('click', ()=> popRose(r));
    balloonStage.appendChild(r);
  }
}

function popRose(r){
  if(!r || r.classList.contains('popped')) return;
  r.classList.add('popped');
  r.classList.add('rose-pop');
  try { popSound.currentTime = 0; popSound.volume = 0.75; popSound.play(); } catch(e){}
  const idx = parseInt(r.dataset.idx) || 0;
  balloonMsg.textContent = roseMessages[idx % roseMessages.length];
  poppedCount++;
  setTimeout(()=> { try{ r.remove() } catch(e){}; 
    if(poppedCount >= roseMessages.length){
      // all popped -> open video after small delay
      setTimeout(()=> openVideoOverlay(), 700);
    }
  }, 420);
}

/* skip to video */
skipToVideoBtn.addEventListener('click', openVideoOverlay);

/* -------------- video overlay -------------- */
function openVideoOverlay(){
  videoOverlay.classList.add('active');
  videoOverlay.setAttribute('aria-hidden','false');
  // pause music while video plays
  try { if(!bgMusic.paused){ bgMusic.pause(); } } catch(e){}
  try { sorryVideo.currentTime = 0; sorryVideo.play().catch(()=>{}); } catch(e){}
}
closeVideo.addEventListener('click', ()=> {
  closeVideoOverlay();
  // after closing continue to final dialog
  step2.style.display='none';
  step4.style.display='flex';
});

continueAfterVideo.addEventListener('click', ()=> {
  closeVideoOverlay();
  step2.style.display='none';
  step4.style.display='flex';
});

function closeVideoOverlay(){
  videoOverlay.classList.remove('active');
  videoOverlay.setAttribute('aria-hidden','true');
  try { sorryVideo.pause(); } catch(e){}
  // resume music segment if still within range
  try {
    if(userInteracted && !bgMusic.paused && bgMusic.currentTime < endTime) { /* already playing */ }
    else if(userInteracted && bgMusic.currentTime < endTime) {
      bgMusic.play().catch(()=>{});
    } else if(userInteracted && bgMusic.currentTime >= endTime) {
      // do nothing; segment finished
    } else {
      // not started
    }
  } catch(e){}
}

/* when video plays: ensure bgMusic pauses */
sorryVideo.addEventListener('play', ()=> {
  try { if(!bgMusic.paused) bgMusic.pause(); } catch(e){}
});
sorryVideo.addEventListener('ended', ()=> {
  // resume music segment after video if within endTime
  try { if(bgMusic.currentTime < endTime){ bgMusic.play().catch(()=>{}); } } catch(e){}
  // after video end go to cartoon
  videoOverlay.classList.remove('active');
  step2.style.display='none';
  step4.style.display='flex';
});

/* -------------- cartoon dialog -------------- */
let dialogIndex = 0;
dialogNextBtn.addEventListener('click', ()=>{
  if(dialogIndex < finalDialogues.length){
    dialogBox.textContent = finalDialogues[dialogIndex];
    dialogIndex++;
  } else {
    // finished -> show final
    step4.style.display='none';
    step5.style.display='flex';
    // fade music out gently
    fadeOutMusic();
  }
});

/* restart */
restartBtn.addEventListener('click', ()=>{
  // reset all states
  dialogIndex = 0;
  poppedCount = 0;
  balloonMsg.textContent = 'Pop a rose â€” each pop has a sorry line ğŸ’Œ';
  step5.style.display='none';
  step1.style.display='flex';
  // stop video
  try{ sorryVideo.pause(); sorryVideo.currentTime = 0; } catch(e){}
  // reset music segment so user must click again to play segment (browser rules)
  try{ bgMusic.pause(); bgMusic.currentTime = startTime; userInteracted = false; } catch(e){}
});

/* fade out helper */
function fadeOutMusic(){
  try{
    const vol = bgMusic.volume || 0.45;
    const steps = 14; let i=0;
    const id = setInterval(()=> {
      i++; bgMusic.volume = Math.max(0, vol * (1 - i/steps));
      if(i>=steps){ clearInterval(id); try{ bgMusic.pause(); bgMusic.volume = vol; }catch(e){} }
    }, 140);
  } catch(e){}
}

/* -------------- click on body to start music segment if user prefers (single click) -------------- */
document.body.addEventListener('click', async function initOnce(){
  // If the user already clicked the startBtn (which calls startMusicSegment) this is ok â€” we won't override.
  if(userInteracted) return;
  // We don't auto-start music here â€” start occurs on pressing Continue Apologize to respect flow.
  // But we set userInteracted true when they click anywhere first time to allow play on next calls (defensive)
  userInteracted = true;
  document.body.removeEventListener('click', initOnce);
}, { once:true });

/* -------------- small accessibility: set canvas size on load -------------- */
window.addEventListener('load', ()=> { resizeCanvas(); makeDrops(); });

</script>
</body>
</html>
